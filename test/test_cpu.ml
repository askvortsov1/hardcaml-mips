open Hardcaml
open Hardcaml_waveterm
open Mips.Cpu
module Simulator = Cyclesim.With_interface (I) (O)

let testbench program n =
  let scope = Scope.create ~flatten_design:true () in
  let sim = Simulator.create (circuit_impl program scope) in
  let waves, sim = Waveform.create sim in

  for _i = 0 to n do
    Cyclesim.cycle sim
  done;

  waves

let display_rules =
  let writeback = Re.Posix.compile (Re.Posix.re "(writeback)") in
  let clock = Re.Posix.compile (Re.Posix.re "(clk)") in
  [
    Display_rule.port_name_matches clock ~wave_format:Wave_format.Bit;
    Display_rule.port_name_matches writeback ~wave_format:Wave_format.Hex;
  ]

(* Regfile initializes as all 0s,
 * and we only have add/subtract/lw/sw,
 * so the output of any writeback will always be 0. *)
let%expect_test "general integration test" =
  let waves = testbench Mips.Program.sample 40 in
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15
    ~display_width:140 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────────────────────────────────│
    │writeback_data    ││ 00000000                                         │00000050 │00000010 │00000004 │00000000                             │
    │                  ││──────────────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
    │writeback_pc      ││ 00000000                                         │00000004 │00000008 │0000000C │0000006C │00000070 │00000074 │0000007│
    │                  ││──────────────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "shift integration" =
  let program =
    Mips.Program.create
      [
        "21090004";
        (* addi $t1 $t0 0x0004 *)
        "00095080";
        (* sll $t2 $t1 0x0002 *)
        "012A5804" (* sllv $t3 $t2 $t1 *);
      ]
  in
  let waves = testbench program 10 in
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15
    ~display_width:140 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────        │
    │                  ││────────────────────────────────────────┬─────────┬─────────┬─────────┬───────────────────────────────────────        │
    │writeback_data    ││ 00000000                               │00000004 │00000010 │00000100 │00000000                                       │
    │                  ││────────────────────────────────────────┴─────────┴─────────┴─────────┴───────────────────────────────────────        │
    │                  ││──────────────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │writeback_pc      ││ 00000000                                         │00000004 │00000008 │0000000C │00000010 │00000014 │00000018         │
    │                  ││──────────────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "alu forwarding integration" =
  let program =
    Mips.Program.create
      [
        "21090007";
        (* addi $t1 $t0 0x0007 *)
        "210A0008";
        (* addi $t2 $t0 0x0008 *)
        "012A5820";
        (* add $t3 $t1 $t2 *)
        "012A6020" (* add $t4 $t1 $t2 *);
      ]
  in
  let waves = testbench program 10 in
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15
    ~display_width:140 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────        │
    │                  ││────────────────────────────────────────┬─────────┬─────────┬───────────────────┬─────────────────────────────        │
    │writeback_data    ││ 00000000                               │00000007 │00000008 │0000000F           │00000000                             │
    │                  ││────────────────────────────────────────┴─────────┴─────────┴───────────────────┴─────────────────────────────        │
    │                  ││──────────────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │writeback_pc      ││ 00000000                                         │00000004 │00000008 │0000000C │00000010 │00000014 │00000018         │
    │                  ││──────────────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "stall/memory forwarding integration" =
  let program =
    Mips.Program.create
      [
        "21090007";
        (* addi $t1 $t0 0x0007 *)
        "210A0008";
        (* addi $t2 $t0 0x0008 *)
        "8D090000";
        (* lw $t1 0($t0) | Reverts $t1 to 0 *)
        "01204020";
        (* add $t0 $t1 $0 | Should output 0 (after a stall) *)
        "012A4020" (* add $t0 $t1 $t2 | Should output 8 *);
      ]
  in
  let waves = testbench program 10 in
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15
    ~display_width:140 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────        │
    │                  ││────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │writeback_data    ││ 00000000                               │00000007 │00000008 │00000000 │00000007 │00000000 │00000008 │00000000         │
    │                  ││────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││──────────────────────────────────────────────────┬─────────┬─────────┬─────────┬───────────────────┬─────────        │
    │writeback_pc      ││ 00000000                                         │00000004 │00000008 │0000000C │00000010           │00000014         │
    │                  ││──────────────────────────────────────────────────┴─────────┴─────────┴─────────┴───────────────────┴─────────        │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "memory integration" =
  let program =
    Mips.Program.create
      [
        "20090004";
        (* addi $t1 $0 0x0004 *)
        "200A0009";
        (* addi $t2 $0 0x0009 *)
        "AD2A0000";
        (* sw $t2 0($t1) *)
        "8D0B0004" (* lw $t3 4($t0) *);
      ]
  in
  let waves = testbench program 10 in
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15
    ~display_width:140 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────        │
    │                  ││────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────────────────────────        │
    │writeback_data    ││ 00000000                               │00000004 │00000009 │00000004 │00000009 │00000000                             │
    │                  ││────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────────────────────────        │
    │                  ││──────────────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │writeback_pc      ││ 00000000                                         │00000004 │00000008 │0000000C │00000010 │00000014 │00000018         │
    │                  ││──────────────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "Test jump" =
  let program =
    Mips.Program.create
      [
        "20090001";
        (* addi $t1 $0 0x0001 *)
        "01294820";
        (* add $t1 $t1 $t1 *)
        "08000001";
        (* j 0x0001 *)
        "01205020" (* add $t2 $t1 $0 *);
      ]
  in
  let waves = testbench program 10 in
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15
    ~display_width:140 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────        │
    │                  ││────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │writeback_data    ││ 00000000                               │00000001 │00000002 │00000000 │00000002 │00000004 │00000000 │00000004         │
    │                  ││────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││──────────────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │writeback_pc      ││ 00000000                                         │00000004 │00000008 │0000000C │00000004 │00000008 │0000000C         │
    │                  ││──────────────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "Test jal" =
  let program =
    Mips.Program.create
      [
        "20090001";
        (* addi $t1 $0 0x0001 *)
        "01294820";
        (* add $t1 $t1 $t1 *)
        "0C000001";
        (* jal 0x0001 *)
        "03E05020" (* add $t2 $ra $0 *);
      ]
  in
  let waves = testbench program 10 in
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15
    ~display_width:140 waves;
  [%expect
    {|
      ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
      │clk_166           ││                                                                                                                      │
      │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────        │
      │                  ││────────────────────────────────────────┬─────────┬─────────┬───────────────────┬─────────┬───────────────────        │
      │writeback_data    ││ 00000000                               │00000001 │00000002 │00000010           │00000004 │00000010                   │
      │                  ││────────────────────────────────────────┴─────────┴─────────┴───────────────────┴─────────┴───────────────────        │
      │                  ││──────────────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
      │writeback_pc      ││ 00000000                                         │00000004 │00000008 │0000000C │00000004 │00000008 │0000000C         │
      │                  ││──────────────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
      │                  ││                                                                                                                      │
      │                  ││                                                                                                                      │
      │                  ││                                                                                                                      │
      │                  ││                                                                                                                      │
      │                  ││                                                                                                                      │
      └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "Test jr" =
  let program =
    Mips.Program.create
      [
        "20090002";
        (* addi $t1 $0 0x0002 *)
        "01294820";
        (* add $t1 $t1 $t1 *)
        "01200008";
        (* jr t1 *)
        "01205020" (* add $t2 $t1 $0 *);
      ]
  in
  let waves = testbench program 10 in
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15
    ~display_width:140 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────        │
    │                  ││────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │writeback_data    ││ 00000000                               │00000002 │00000004 │00000000 │00000004 │00000008 │00000000 │00000008         │
    │                  ││────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││──────────────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │writeback_pc      ││ 00000000                                         │00000004 │00000008 │0000000C │00000004 │00000008 │0000000C         │
    │                  ││──────────────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "Test bne" =
  let program =
    Mips.Program.create
      [
        "15090020";
        (* bne t0 t1 32 *)
        "20090001";
        (* addi $t1 $0 0x0001 *)
        "15090040" (* bne t0 t1 64 *);
      ]
  in
  let waves = testbench program 10 in
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15
    ~display_width:140 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────        │
    │                  ││──────────────────────────────────────────────────┬─────────┬─────────────────────────────────────────────────        │
    │writeback_data    ││ 00000000                                         │00000001 │00000000                                                 │
    │                  ││──────────────────────────────────────────────────┴─────────┴─────────────────────────────────────────────────        │
    │                  ││──────────────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │writeback_pc      ││ 00000000                                         │00000004 │00000008 │0000000C │0000010C │00000110 │00000114         │
    │                  ││──────────────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "Test beq" =
  let program =
    Mips.Program.create
      [
        "20080001";
        (* addi $t0 $0 0x0001 *)
        "11090020";
        (* beq t0 t1 32 *)
        "20090001";
        (* addi $t1 $0 0x0001 *)
        "11090040" (* beq t0 t1 64 *);
      ]
  in
  let waves = testbench program 10 in
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15
    ~display_width:140 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────        │
    │                  ││────────────────────────────────────────┬─────────┬─────────┬─────────┬───────────────────────────────────────        │
    │writeback_data    ││ 00000000                               │00000001 │00000000 │00000001 │00000000                                       │
    │                  ││────────────────────────────────────────┴─────────┴─────────┴─────────┴───────────────────────────────────────        │
    │                  ││──────────────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │writeback_pc      ││ 00000000                                         │00000004 │00000008 │0000000C │00000010 │00000110 │00000114         │
    │                  ││──────────────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "stall from IO pauses execution correctly." =
  let program =
    Mips.Program.create
      [
        "3C08FFFF" (* lui t0 0xFFFF *);
        "3508FFFF" (* ori t0 t0 0xFFFF *);
        "214A0008" (* addi $t2 $t2 0x0008 *);
        "216B0005" (* addi $t3 $t3 0x0005 *);
        "8D0C0000" (* lw $t4 0($t0) *);
        "214A0008" (* addi $t2 $t3 0x0008 *);
        "000C6820" (* add $t5 $zero $t4 *);
        "216B0005" (* addi $t3 $t2 0x0005 *);
      ]
  in
  let waves = testbench program 14 in
  (* Note that we start later to fit the entire waveform *)
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15 ~start_cycle:3
    ~display_width:140 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────┬─────────┬─────────┬─────────┬───────────────────────────────────────┬─────────┬─────────┬─────────┬───────│
    │writeback_data    ││ 00000000 │FFFF0000 │FFFFFFFF │00000008 │00000005                               │00000010 │00000005 │0000000A │0000000│
    │                  ││──────────┴─────────┴─────────┴─────────┴───────────────────────────────────────┴─────────┴─────────┴─────────┴───────│
    │                  ││────────────────────┬─────────┬─────────┬─────────────────────────────┬─────────┬─────────┬─────────┬─────────┬───────│
    │writeback_pc      ││ 00000000           │00000004 │00000008 │0000000C                     │00000010 │00000014 │00000018 │0000001C │0000002│
    │                  ││────────────────────┴─────────┴─────────┴─────────────────────────────┴─────────┴─────────┴─────────┴─────────┴───────│
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "back to back async mem reads work correctly." =
  let program =
    Mips.Program.create
      [
        "3C08FFFF" (* lui t0 0xFFFF *);
        "3508FFFF" (* ori t0 t0 0xFFFF *);
        "8D0C0000" (* lw $t4 0($t0) *);
        "8D0D0000" (* lw $t5 0($t0) *);
        "018D7020" (* add $t6 $t4 $t5 *);
      ]
  in
  let waves = testbench program 14 in
  (* Note that we start later to fit the entire waveform *)
  Waveform.print ~display_rules ~wave_width:4 ~display_height:15 ~start_cycle:3
    ~display_width:140 waves;
  [%expect
    {|
      ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
      │clk_166           ││                                                                                                                      │
      │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │                  ││──────────┬─────────┬─────────────────────────────┬─────────────────────────────────────────────────┬─────────┬───────│
      │writeback_data    ││ 00000000 │FFFF0000 │FFFFFFFF                     │00000005                                         │0000000A │0000000│
      │                  ││──────────┴─────────┴─────────────────────────────┴─────────────────────────────────────────────────┴─────────┴───────│
      │                  ││────────────────────┬─────────────────────────────┬─────────────────────────────┬─────────┬─────────┬─────────────────│
      │writeback_pc      ││ 00000000           │00000004                     │00000008                     │0000000C │00000010 │00000014         │
      │                  ││────────────────────┴─────────────────────────────┴─────────────────────────────┴─────────┴─────────┴─────────────────│
      │                  ││                                                                                                                      │
      │                  ││                                                                                                                      │
      │                  ││                                                                                                                      │
      │                  ││                                                                                                                      │
      │                  ││                                                                                                                      │
      └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
