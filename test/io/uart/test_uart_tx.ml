open Hardcaml
open Hardcaml_waveterm

let clock = Signal.input "clock" 1

let waves =
  let valid = Signal.input "valid" 1 in
  let value = Signal.input "value" 32 in
  let tx_sm = Mips.Uart.Tx_buffer.create ~clock { valid; value } in
  let uart_tx_value = Signal.output "uart_tx_value" tx_sm.value in
  let uart_tx_valid = Signal.output "uart_tx_valid" tx_sm.valid in
  let circuit =
    Circuit.create_exn ~name:"tx_state_machine" [ uart_tx_value; uart_tx_valid ]
  in
  let waves, sim =
    Hardcaml_waveterm.Waveform.create
      (Cyclesim.create ~config:Cyclesim.Config.trace_all circuit)
  in
  Cyclesim.cycle sim;
  Cyclesim.cycle sim;
  Cyclesim.in_port sim "valid" := Bits.vdd;
  Cyclesim.in_port sim "value" := Bits.of_string "32'h61727479" (* "arty" *);
  Cyclesim.cycle sim;
  Cyclesim.in_port sim "valid" := Bits.gnd;
  for _ = 0 to Mips.Uart.cycles_per_packet * 4 do
    Cyclesim.cycle sim
  done;
  waves

let%expect_test "tx_first_byte" =
  Waveform.print ~display_width:100 ~display_height:25 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐ │
    │                  ││    └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └─│
    │valid             ││                ┌───────┐                                                     │
    │                  ││────────────────┘       └─────────────────────────────────────────────────────│
    │                  ││────────────────┬─────────────────────────────────────────────────────────────│
    │value             ││ 00000000       │61727479                                                     │
    │                  ││────────────────┴─────────────────────────────────────────────────────────────│
    │uart_tx_valid     ││                        ┌─────────────────────────────────────────────────────│
    │                  ││────────────────────────┘                                                     │
    │                  ││────────────────────────┬─────────────────────────────────────────────────────│
    │uart_tx_value     ││ 00                     │61                                                   │
    │                  ││────────────────────────┴─────────────────────────────────────────────────────│
    │vdd               ││──────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                              │
    │                  ││                                                                              │
    │                  ││                                                                              │
    │                  ││                                                                              │
    │                  ││                                                                              │
    │                  ││                                                                              │
    │                  ││                                                                              │
    │                  ││                                                                              │
    │                  ││                                                                              │
    │                  ││                                                                              │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "tx_second_byte" =
  Waveform.print ~start_cycle:Mips.Uart.cycles_per_packet ~display_width:100
    ~display_height:25 waves;
  [%expect
    {|
      ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
      │clock             ││┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐ │
      │                  ││    └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └─│
      │valid             ││                                                                              │
      │                  ││──────────────────────────────────────────────────────────────────────────────│
      │                  ││──────────────────────────────────────────────────────────────────────────────│
      │value             ││ 61727479                                                                     │
      │                  ││──────────────────────────────────────────────────────────────────────────────│
      │uart_tx_valid     ││────────────────────────────────┐       ┌─────────────────────────────────────│
      │                  ││                                └───────┘                                     │
      │                  ││────────────────────────────────┬─────────────────────────────────────────────│
      │uart_tx_value     ││ 61                             │72                                           │
      │                  ││────────────────────────────────┴─────────────────────────────────────────────│
      │vdd               ││──────────────────────────────────────────────────────────────────────────────│
      │                  ││                                                                              │
      │                  ││                                                                              │
      │                  ││                                                                              │
      │                  ││                                                                              │
      │                  ││                                                                              │
      │                  ││                                                                              │
      │                  ││                                                                              │
      │                  ││                                                                              │
      │                  ││                                                                              │
      │                  ││                                                                              │
      └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "tx_third_byte" =
  Waveform.print
    ~start_cycle:(Mips.Uart.cycles_per_packet * 2)
    ~display_width:100 ~display_height:25 waves;
  [%expect
    {|
        ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
        │clock             ││┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐ │
        │                  ││    └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └─│
        │valid             ││                                                                              │
        │                  ││──────────────────────────────────────────────────────────────────────────────│
        │                  ││──────────────────────────────────────────────────────────────────────────────│
        │value             ││ 61727479                                                                     │
        │                  ││──────────────────────────────────────────────────────────────────────────────│
        │uart_tx_valid     ││────────────────────────────────────────────────┐       ┌─────────────────────│
        │                  ││                                                └───────┘                     │
        │                  ││────────────────────────────────────────────────┬─────────────────────────────│
        │uart_tx_value     ││ 72                                             │74                           │
        │                  ││────────────────────────────────────────────────┴─────────────────────────────│
        │vdd               ││──────────────────────────────────────────────────────────────────────────────│
        │                  ││                                                                              │
        │                  ││                                                                              │
        │                  ││                                                                              │
        │                  ││                                                                              │
        │                  ││                                                                              │
        │                  ││                                                                              │
        │                  ││                                                                              │
        │                  ││                                                                              │
        │                  ││                                                                              │
        │                  ││                                                                              │
        └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "tx_fourth_byte" =
  Waveform.print
    ~start_cycle:(Mips.Uart.cycles_per_packet * 3)
    ~display_width:100 ~display_height:25 waves;
  [%expect
    {|
          ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
          │clock             ││┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐ │
          │                  ││    └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └─│
          │valid             ││                                                                              │
          │                  ││──────────────────────────────────────────────────────────────────────────────│
          │                  ││──────────────────────────────────────────────────────────────────────────────│
          │value             ││ 61727479                                                                     │
          │                  ││──────────────────────────────────────────────────────────────────────────────│
          │uart_tx_valid     ││────────────────────────────────────────────────────────────────┐       ┌─────│
          │                  ││                                                                └───────┘     │
          │                  ││────────────────────────────────────────────────────────────────┬─────────────│
          │uart_tx_value     ││ 74                                                             │79           │
          │                  ││────────────────────────────────────────────────────────────────┴─────────────│
          │vdd               ││──────────────────────────────────────────────────────────────────────────────│
          │                  ││                                                                              │
          │                  ││                                                                              │
          │                  ││                                                                              │
          │                  ││                                                                              │
          │                  ││                                                                              │
          │                  ││                                                                              │
          │                  ││                                                                              │
          │                  ││                                                                              │
          │                  ││                                                                              │
          │                  ││                                                                              │
          └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘ |}]
