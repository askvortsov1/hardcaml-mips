open Hardcaml
open Hardcaml_waveterm
open Mips.Cpu
module Simulator = Cyclesim.With_interface (I) (O)

let waves program run =
  let scope = Scope.create ~flatten_design:true () in
  let sim = Simulator.create (circuit_impl program scope) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in

  run sim inputs;

  waves

let display_rules =
  let writeback = Re.Posix.compile (Re.Posix.re "(writeback)") in
  let clock = Re.Posix.compile (Re.Posix.re "(clk)") in
  let uart = Re.Posix.compile (Re.Posix.re "(uart)") in
  [
    Display_rule.port_name_matches clock ~wave_format:Wave_format.Bit;
    Display_rule.port_name_matches writeback ~wave_format:Wave_format.Hex;
    Display_rule.port_name_matches uart ~wave_format:Wave_format.Hex;
  ]

let read_then_output_uart_back_to_back_waves =
  let program =
    Mips.Program.create
      [
        "3C10FFFF" (* (0) lui $s0 0xFFFF *);
        "3610FFFE" (* (4) ori $s0 $s0 0xFFFE *);
        "20110030" (* (8) addi $s1 $zero 0x0030 *);
        "8E080000" (* (C) lw $t0 0x0000 $s0 *);
        "21080001" (* (10) addi $t0 $t0 0x0001 *);
        "AE080000" (* (14) sw $t0 0x0000 $s0 *);
        "8E090000" (* (18) lw $t1 0x0000 $s0 *);
        "21290002" (* (1C) addi $t1 $t1 0x0002 *);
        "AE090000" (* (20) sw $t1 0x0000 $s0 *);
        "200D5329" (* (24) addi $t5 $zero 0x5329 *);
      ]
  in
  waves program (fun sim (inputs : Bits.t ref I.t) ->
      for _ = 0 to 7 do
        Cyclesim.cycle sim
      done;

      (* Transmit first "word" *)
      for _ = 0 to Mips.Uart.cycles_per_packet - 1 do
        Cyclesim.cycle sim
      done;
      inputs.uart_rx.valid := Bits.vdd;
      inputs.uart_rx.value := Bits.of_string "8'h31" (* "1" *);
      Cyclesim.cycle sim;
      inputs.uart_rx.valid := Bits.gnd;

      for _ = 0 to Mips.Uart.cycles_per_packet - 1 do
        Cyclesim.cycle sim
      done;
      inputs.uart_rx.valid := Bits.vdd;
      inputs.uart_rx.value := Bits.of_string "8'h0A" (* "\n" *);
      Cyclesim.cycle sim;
      inputs.uart_rx.valid := Bits.gnd;

      (* Wait for word to be transmitted back *)
      for _ = 0 to Mips.Uart.cycles_per_packet * 4 do
        Cyclesim.cycle sim;
        inputs.uart_rx.valid := Bits.gnd
      done;

      (* Transmit second word *)
      for _ = 0 to Mips.Uart.cycles_per_packet do
        Cyclesim.cycle sim
      done;
      inputs.uart_rx.valid := Bits.vdd;
      inputs.uart_rx.value := Bits.of_string "8'h61" (* "a" *);
      Cyclesim.cycle sim;
      inputs.uart_rx.valid := Bits.gnd;

      for _ = 0 to Mips.Uart.cycles_per_packet do
        Cyclesim.cycle sim
      done;
      inputs.uart_rx.valid := Bits.vdd;
      inputs.uart_rx.value := Bits.of_string "8'h72" (* "r" *);
      Cyclesim.cycle sim;
      inputs.uart_rx.valid := Bits.gnd;

      for _ = 0 to Mips.Uart.cycles_per_packet do
        Cyclesim.cycle sim
      done;
      inputs.uart_rx.valid := Bits.vdd;
      inputs.uart_rx.value := Bits.of_string "8'h74" (* "t" *);
      Cyclesim.cycle sim;
      inputs.uart_rx.valid := Bits.gnd;

      for _ = 0 to Mips.Uart.cycles_per_packet do
        Cyclesim.cycle sim
      done;
      inputs.uart_rx.valid := Bits.vdd;
      inputs.uart_rx.value := Bits.of_string "8'h79" (* "7" *);
      Cyclesim.cycle sim;
      inputs.uart_rx.valid := Bits.gnd;

      (* Wait for word to be transmitted back, conclude program *)
      for _ = 0 to Mips.Uart.cycles_per_packet * 5 do
        Cyclesim.cycle sim;
        inputs.uart_rx.valid := Bits.gnd
      done;)

let%expect_test "setup" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────┬───────┬───────┬─────────────────────────────────────────────────────────────────────│
    │writeback_data    ││ 00000000                       │FFFF00.│FFFFFF.│00000030                                                             │
    │                  ││────────────────────────────────┴───────┴───────┴─────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────┬───────┬─────────────────────────────────────────────────────────────────────│
    │writeback_pc      ││ 00000000                               │000000.│00000008                                                             │
    │                  ││────────────────────────────────────────┴───────┴─────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │uart_rx_valid     ││ 0                                                                                                                    │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │uart_rx_value     ││ 00                                                                                                                   │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │uart_tx_valid     ││ 0                                                                                                                    │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │uart_tx_value     ││ 00                                                                                                                   │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "received first byte" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.(cycles_per_packet + 5)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │writeback_data    ││ 00000030                                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │writeback_pc      ││ 00000008                                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────┬───────┬─────────────────────────────────────────────────────────────────────────────────────│
    │uart_rx_valid     ││ 0                      │1      │0                                                                                    │
    │                  ││────────────────────────┴───────┴─────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────│
    │uart_rx_value     ││ 00                     │31                                                                                           │
    │                  ││────────────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │uart_tx_valid     ││ 0                                                                                                                    │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │uart_tx_value     ││ 00                                                                                                                   │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "receive second byte (end of first word), start transmitting \
                 back response" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 2) + 7)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clk_166           ││                                                                                                                      │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────┬───────┬───────┬─────────────────────────────────────────────────────────────────────│
    │writeback_data    ││ 00000030                       │310A00.│000000.│310A0001                                                             │
    │                  ││────────────────────────────────┴───────┴───────┴─────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────┬───────┬───────┬─────────────────────────────────────────────────────────────────────│
    │writeback_pc      ││ 00000008                       │000000.│000000.│00000014                                                             │
    │                  ││────────────────────────────────┴───────┴───────┴─────────────────────────────────────────────────────────────────────│
    │                  ││────────────────┬───────┬─────────────────────────────────────────────────────────────────────────────────────────────│
    │uart_rx_valid     ││ 0              │1      │0                                                                                            │
    │                  ││────────────────┴───────┴─────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────│
    │uart_rx_value     ││ 31             │0A                                                                                                   │
    │                  ││────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────┬───────┬─────────────────────────────────────────────────────│
    │uart_tx_valid     ││ 0                                                      │1      │0                                                    │
    │                  ││────────────────────────────────────────────────────────┴───────┴─────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────│
    │uart_tx_value     ││ 00                                                     │31                                                           │
    │                  ││────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────│
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    │                  ││                                                                                                                      │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "send second byte of response" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 3) + 9)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
  ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │clk_166           ││                                                                                                                      │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │writeback_data    ││ 310A0001                                                                                                             │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │writeback_pc      ││ 00000014                                                                                                             │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │uart_rx_valid     ││ 0                                                                                                                    │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │uart_rx_value     ││ 0A                                                                                                                   │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││────────────────────────────────────────────────────────┬───────┬─────────────────────────────────────────────────────│
  │uart_tx_valid     ││ 0                                                      │1      │0                                                    │
  │                  ││────────────────────────────────────────────────────────┴───────┴─────────────────────────────────────────────────────│
  │                  ││────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────│
  │uart_tx_value     ││ 31                                                     │0A                                                           │
  │                  ││────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────│
  │                  ││                                                                                                                      │
  │                  ││                                                                                                                      │
  │                  ││                                                                                                                      │
  └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "send third byte of response" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 4) + 11)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
  ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │clk_166           ││                                                                                                                      │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │writeback_data    ││ 310A0001                                                                                                             │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │writeback_pc      ││ 00000014                                                                                                             │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │uart_rx_valid     ││ 0                                                                                                                    │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │uart_rx_value     ││ 0A                                                                                                                   │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││────────────────────────────────────────────────────────┬───────┬─────────────────────────────────────────────────────│
  │uart_tx_valid     ││ 0                                                      │1      │0                                                    │
  │                  ││────────────────────────────────────────────────────────┴───────┴─────────────────────────────────────────────────────│
  │                  ││────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────│
  │uart_tx_value     ││ 0A                                                     │00                                                           │
  │                  ││────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────│
  │                  ││                                                                                                                      │
  │                  ││                                                                                                                      │
  │                  ││                                                                                                                      │
  └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "send fourth byte of response" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 5) + 13)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
  ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │clk_166           ││                                                                                                                      │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │writeback_data    ││ 310A0001                                                                                                             │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │writeback_pc      ││ 00000014                                                                                                             │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │uart_rx_valid     ││ 0                                                                                                                    │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │uart_rx_value     ││ 0A                                                                                                                   │
  │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
  │                  ││────────────────────────────────────────────────────────┬───────┬─────────────────────────────────────────────────────│
  │uart_tx_valid     ││ 0                                                      │1      │0                                                    │
  │                  ││────────────────────────────────────────────────────────┴───────┴─────────────────────────────────────────────────────│
  │                  ││────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────│
  │uart_tx_value     ││ 00                                                     │01                                                           │
  │                  ││────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────│
  │                  ││                                                                                                                      │
  │                  ││                                                                                                                      │
  │                  ││                                                                                                                      │
  └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "finished transmitting response" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 6) + 13)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│clk_166           ││                                                                                                                      │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────│
│writeback_data    ││ 310A0001                                                                       │FFFFFFFE                             │
│                  ││────────────────────────────────────────────────────────────────────────────────┴─────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_pc      ││ 00000014                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_rx_valid     ││ 0                                                                                                                    │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_rx_value     ││ 0A                                                                                                                   │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_tx_valid     ││ 0                                                                                                                    │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────│
│uart_tx_value     ││ 01                                                                     │31                                           │
│                  ││────────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────│
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
└──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "get first byte of second word" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 7) + 5)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│clk_166           ││                                                                                                                      │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_data    ││ FFFFFFFE                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_pc      ││ 00000014                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────┬───────┬─────────────────────────────────────────────────────│
│uart_rx_valid     ││ 0                                                      │1      │0                                                    │
│                  ││────────────────────────────────────────────────────────┴───────┴─────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────│
│uart_rx_value     ││ 0A                                                     │61                                                           │
│                  ││────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_tx_valid     ││ 0                                                                                                                    │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_tx_value     ││ 31                                                                                                                   │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
└──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "get second byte of second word" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 8) + 7)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│clk_166           ││                                                                                                                      │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_data    ││ FFFFFFFE                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_pc      ││ 00000014                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────┬───────┬─────────────────────────────────────────────────────│
│uart_rx_valid     ││ 0                                                      │1      │0                                                    │
│                  ││────────────────────────────────────────────────────────┴───────┴─────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────│
│uart_rx_value     ││ 61                                                     │72                                                           │
│                  ││────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_tx_valid     ││ 0                                                                                                                    │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_tx_value     ││ 31                                                                                                                   │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
└──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "get third byte of second word" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 9) + 9)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│clk_166           ││                                                                                                                      │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_data    ││ FFFFFFFE                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_pc      ││ 00000014                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────┬───────┬─────────────────────────────────────────────────────│
│uart_rx_valid     ││ 0                                                      │1      │0                                                    │
│                  ││────────────────────────────────────────────────────────┴───────┴─────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────│
│uart_rx_value     ││ 72                                                     │74                                                           │
│                  ││────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_tx_valid     ││ 0                                                                                                                    │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_tx_value     ││ 31                                                                                                                   │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
└──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "get fourth byte of second word, start transmitting" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 10) + 11)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│clk_166           ││                                                                                                                      │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────┬───────┬───────┬─────────────────────────────│
│writeback_data    ││ FFFFFFFE                                                               │617274.│000000.│6172747B                     │
│                  ││────────────────────────────────────────────────────────────────────────┴───────┴───────┴─────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────┬───────┬───────┬─────────────────────────────│
│writeback_pc      ││ 00000014                                                               │000000.│000000.│00000020                     │
│                  ││────────────────────────────────────────────────────────────────────────┴───────┴───────┴─────────────────────────────│
│                  ││────────────────────────────────────────────────────────┬───────┬─────────────────────────────────────────────────────│
│uart_rx_valid     ││ 0                                                      │1      │0                                                    │
│                  ││────────────────────────────────────────────────────────┴───────┴─────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────│
│uart_rx_value     ││ 74                                                     │79                                                           │
│                  ││────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┬───────┬─────────────│
│uart_tx_valid     ││ 0                                                                                              │1      │0            │
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┴───────┴─────────────│
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────│
│uart_tx_value     ││ 31                                                                                             │61                   │
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────────│
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
└──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "get fourth byte of second word, start transmitting" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 10) + 11)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│clk_166           ││                                                                                                                      │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────┬───────┬───────┬─────────────────────────────│
│writeback_data    ││ FFFFFFFE                                                               │617274.│000000.│6172747B                     │
│                  ││────────────────────────────────────────────────────────────────────────┴───────┴───────┴─────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────┬───────┬───────┬─────────────────────────────│
│writeback_pc      ││ 00000014                                                               │000000.│000000.│00000020                     │
│                  ││────────────────────────────────────────────────────────────────────────┴───────┴───────┴─────────────────────────────│
│                  ││────────────────────────────────────────────────────────┬───────┬─────────────────────────────────────────────────────│
│uart_rx_valid     ││ 0                                                      │1      │0                                                    │
│                  ││────────────────────────────────────────────────────────┴───────┴─────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────│
│uart_rx_value     ││ 74                                                     │79                                                           │
│                  ││────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┬───────┬─────────────│
│uart_tx_valid     ││ 0                                                                                              │1      │0            │
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┴───────┴─────────────│
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────│
│uart_tx_value     ││ 31                                                                                             │61                   │
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────────│
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
└──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "start transmit second byte of second word" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 11) + 13)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│clk_166           ││                                                                                                                      │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_data    ││ 6172747B                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_pc      ││ 00000020                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_rx_valid     ││ 0                                                                                                                    │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_rx_value     ││ 79                                                                                                                   │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┬───────┬─────────────│
│uart_tx_valid     ││ 0                                                                                              │1      │0            │
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┴───────┴─────────────│
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────│
│uart_tx_value     ││ 61                                                                                             │72                   │
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────────│
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
└──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "start transmit third byte of second word" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 12) + 15)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│clk_166           ││                                                                                                                      │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_data    ││ 6172747B                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_pc      ││ 00000020                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_rx_valid     ││ 0                                                                                                                    │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_rx_value     ││ 79                                                                                                                   │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┬───────┬─────────────│
│uart_tx_valid     ││ 0                                                                                              │1      │0            │
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┴───────┴─────────────│
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────│
│uart_tx_value     ││ 72                                                                                             │74                   │
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────────│
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
└──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "start transmit fourth byte of second word" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 13) + 17)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│clk_166           ││                                                                                                                      │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_data    ││ 6172747B                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│writeback_pc      ││ 00000020                                                                                                             │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_rx_valid     ││ 0                                                                                                                    │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_rx_value     ││ 79                                                                                                                   │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┬───────┬─────────────│
│uart_tx_valid     ││ 0                                                                                              │1      │0            │
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┴───────┴─────────────│
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────│
│uart_tx_value     ││ 74                                                                                             │7B                   │
│                  ││────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────────│
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
└──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]

let%expect_test "finish transmitting second word, end program" =
  Waveform.print ~display_rules ~display_width:140 ~display_height:25
    ~start_cycle:Mips.Uart.((cycles_per_packet * 14) + 24)
    read_then_output_uart_back_to_back_waves;
  [%expect
    {|
┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│clk_166           ││                                                                                                                      │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────┬───────┬───────┬─────────────────────────────────────│
│writeback_data    ││ 6172747B                                                       │FFFFFF.│000053.│00000000                             │
│                  ││────────────────────────────────────────────────────────────────┴───────┴───────┴─────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────────┬───────┬───────┬───────┬───────┬───────┬─────│
│writeback_pc      ││ 00000020                                                               │000000.│000000.│000000.│000000.│000000.│00000│
│                  ││────────────────────────────────────────────────────────────────────────┴───────┴───────┴───────┴───────┴───────┴─────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_rx_valid     ││ 0                                                                                                                    │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_rx_value     ││ 79                                                                                                                   │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│uart_tx_valid     ││ 0                                                                                                                    │
│                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────│
│uart_tx_value     ││ 7B                                                     │61                                                           │
│                  ││────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────│
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
│                  ││                                                                                                                      │
└──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]