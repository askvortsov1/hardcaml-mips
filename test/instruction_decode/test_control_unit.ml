open Hardcaml
open Hardcaml_waveterm
open Mips.Control_unit
module Simulator = Cyclesim.With_interface (I) (O)

let testbench instructions =
  let scope = Scope.create ~flatten_design:true () in
  let sim = Simulator.create (circuit_impl_exn scope) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in

  let step ~instruction =
    inputs.instruction := Bits.of_string instruction;
    Cyclesim.cycle sim
  in

  List.iter (fun instr -> step ~instruction:instr) instructions;
  waves

let%expect_test "Uses different rdest for RType and IType" =
  let add_rd_is_9 = "32'h014B4820" in
  let lw_rt_is_8 = "32'h8D280000" in

  let waves = testbench [ add_rd_is_9; lw_rt_is_8 ] in
  let display_rule =
    Display_rule.Names
      {
        names =
          List.map Expert.Port_name.of_string
            [ "instruction"; "rs"; "rt"; "rdest" ];
        wave_format = Wave_format.Hex;
        alignment = Wave_format.Left;
      }
  in
  Waveform.print ~display_rules:[ display_rule ] ~wave_width:4 ~display_width:90
    ~display_height:20 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │                  ││──────────┬─────────                                                │
    │instruction       ││ 014B4820 │8D280000                                                 │
    │                  ││──────────┴─────────                                                │
    │                  ││──────────┬─────────                                                │
    │rdest             ││ 09       │08                                                       │
    │                  ││──────────┴─────────                                                │
    │                  ││──────────┬─────────                                                │
    │rs                ││ 0A       │09                                                       │
    │                  ││──────────┴─────────                                                │
    │                  ││──────────┬─────────                                                │
    │rt                ││ 0B       │08                                                       │
    │                  ││──────────┴─────────                                                │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘
  |}]

let%expect_test "Control signals and alu_imm correct for arithmetic ops" =
  let add = "32'h012A4020" in
  let addu = "32'h012A4021" in
  let addi = "32'h2128FFAA" in
  let addiu = "32'h2528FFAA" in
  let sub = "32'h012A4022" in
  let subu = "32'h012A4023" in

  let waves = testbench [ add; addu; addi; addiu; sub; subu ] in
  Waveform.print ~wave_width:4 ~display_width:90 ~display_height:35 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │instruction       ││ 012A4020 │012A4021 │2128FFAA │2528FFAA │012A4022 │012A4023         │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││──────────┬─────────────────────────────┬─────────┬─────────        │
    │alu_control       ││ 02       │03                           │0C       │0D               │
    │                  ││──────────┴─────────────────────────────┴─────────┴─────────        │
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │alu_imm           ││ 00004020 │00004021 │FFFFFFAA │0000FFAA │00004022 │00004023         │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │mem_write_enable  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    │                  ││────────────────────────────────────────────────────────────        │
    │rdest             ││ 08                                                                 │
    │                  ││────────────────────────────────────────────────────────────        │
    │reg_write_enable  ││────────────────────────────────────────────────────────────        │
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    │rs                ││ 09                                                                 │
    │                  ││────────────────────────────────────────────────────────────        │
    │                  ││────────────────────┬───────────────────┬───────────────────        │
    │rt                ││ 0A                 │08                 │0A                         │
    │                  ││────────────────────┴───────────────────┴───────────────────        │
    │sel_imm_for_alu   ││                    ┌───────────────────┐                           │
    │                  ││────────────────────┘                   └───────────────────        │
    │sel_mem_for_reg_da││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    │sel_shift_for_alu ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    │                  ││────────────────────┬───────────────────┬───────────────────        │
    │shamt             ││ 00                 │1E                 │00                         │
    │                  ││────────────────────┴───────────────────┴───────────────────        │
    │stall_pc          ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘
  |}]

let%expect_test "Control signals and alu_imm correct for logical ops" =
  let and_ = "32'h012A4024" in
  let andi = "32'h3128FFAA" in
  let or_ = "32'h012A4025" in
  let ori = "32'h3528FFAA" in
  let xor = "32'h012A4026" in
  let xori = "32'h3928FFAA" in

  let waves = testbench [ and_; andi; or_; ori; xor; xori ] in
  Waveform.print ~wave_width:4 ~display_width:90 ~display_height:35 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │instruction       ││ 012A4024 │3128FFAA │012A4025 │3528FFAA │012A4026 │3928FFAA         │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││────────────────────┬───────────────────┬───────────────────        │
    │alu_control       ││ 04                 │06                 │0E                         │
    │                  ││────────────────────┴───────────────────┴───────────────────        │
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │alu_imm           ││ 00004024 │0000FFAA │00004025 │0000FFAA │00004026 │0000FFAA         │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │mem_write_enable  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    │                  ││────────────────────────────────────────────────────────────        │
    │rdest             ││ 08                                                                 │
    │                  ││────────────────────────────────────────────────────────────        │
    │reg_write_enable  ││────────────────────────────────────────────────────────────        │
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    │rs                ││ 09                                                                 │
    │                  ││────────────────────────────────────────────────────────────        │
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │rt                ││ 0A       │08       │0A       │08       │0A       │08               │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │sel_imm_for_alu   ││          ┌─────────┐         ┌─────────┐         ┌─────────        │
    │                  ││──────────┘         └─────────┘         └─────────┘                 │
    │sel_mem_for_reg_da││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    │sel_shift_for_alu ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │shamt             ││ 00       │1E       │00       │1E       │00       │1E               │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │stall_pc          ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘
  |}]

let%expect_test "Control signals and alu_imm correct for shift ops" =
  let sll = "32'h00094100" in
  let sllv = "32'h01494004" in
  let srl = "32'h00094102" in
  let srlv = "32'h01494006" in
  let sra = "32'h00094103" in
  let srav = "32'h01494007" in

  let waves = testbench [ sll; sllv; srl; srlv; sra; srav ] in
  Waveform.print ~wave_width:4 ~display_width:90 ~display_height:35 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │instruction       ││ 00094100 │01494004 │00094102 │01494006 │00094103 │01494007         │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││──────────┬─────────┬───────────────────┬───────────────────        │
    │alu_control       ││ 09       │00       │0B                 │0A                         │
    │                  ││──────────┴─────────┴───────────────────┴───────────────────        │
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │alu_imm           ││ 00004100 │00004004 │00004102 │00004006 │00004103 │00004007         │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │mem_write_enable  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    │                  ││────────────────────────────────────────────────────────────        │
    │rdest             ││ 08                                                                 │
    │                  ││────────────────────────────────────────────────────────────        │
    │reg_write_enable  ││────────────────────────────────────────────────────────────        │
    │                  ││                                                                    │
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │rs                ││ 00       │0A       │00       │0A       │00       │0A               │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │                  ││────────────────────────────────────────────────────────────        │
    │rt                ││ 09                                                                 │
    │                  ││────────────────────────────────────────────────────────────        │
    │sel_imm_for_alu   ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    │sel_mem_for_reg_da││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    │sel_shift_for_alu ││──────────┐         ┌─────────┐         ┌─────────┐                 │
    │                  ││          └─────────┘         └─────────┘         └─────────        │
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────        │
    │shamt             ││ 04       │00       │04       │00       │04       │00               │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────        │
    │stall_pc          ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────        │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘
  |}]

let%expect_test "Control signals and alu_imm correct for Other I type ops" =
  let lui = "32'h3C08FFAA" in

  (* alu_imm sign vs zero extended doesn't matter here,
   * because we only use the last 16 bits of imm. *)
  let waves = testbench [ lui ] in
  Waveform.print ~wave_width:4 ~display_width:90 ~display_height:35 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │                  ││──────────                                                          │
    │instruction       ││ 3C08FFAA                                                           │
    │                  ││──────────                                                          │
    │                  ││──────────                                                          │
    │alu_control       ││ 05                                                                 │
    │                  ││──────────                                                          │
    │                  ││──────────                                                          │
    │alu_imm           ││ FFFFFFAA                                                           │
    │                  ││──────────                                                          │
    │mem_write_enable  ││                                                                    │
    │                  ││──────────                                                          │
    │                  ││──────────                                                          │
    │rdest             ││ 08                                                                 │
    │                  ││──────────                                                          │
    │reg_write_enable  ││──────────                                                          │
    │                  ││                                                                    │
    │                  ││──────────                                                          │
    │rs                ││ 00                                                                 │
    │                  ││──────────                                                          │
    │                  ││──────────                                                          │
    │rt                ││ 08                                                                 │
    │                  ││──────────                                                          │
    │sel_imm_for_alu   ││──────────                                                          │
    │                  ││                                                                    │
    │sel_mem_for_reg_da││                                                                    │
    │                  ││──────────                                                          │
    │sel_shift_for_alu ││                                                                    │
    │                  ││──────────                                                          │
    │                  ││──────────                                                          │
    │shamt             ││ 1E                                                                 │
    │                  ││──────────                                                          │
    │stall_pc          ││                                                                    │
    │                  ││──────────                                                          │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘
  |}]

let%expect_test "Control signals and alu_imm correct for comparison ops" =
  let slt = "32'h012A402A" in
  let sltu = "32'h012A402B" in
  let slti = "32'h2928FFAA" in
  let sltiu = "32'h2D28FFAA" in

  let waves = testbench [ slt; sltu; slti; sltiu ] in
  Waveform.print ~wave_width:4 ~display_width:90 ~display_height:35 waves;
  [%expect
    {|
  ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
  │                  ││──────────┬─────────┬─────────┬─────────                            │
  │instruction       ││ 012A402A │012A402B │2928FFAA │2D28FFAA                             │
  │                  ││──────────┴─────────┴─────────┴─────────                            │
  │                  ││──────────┬─────────┬─────────┬─────────                            │
  │alu_control       ││ 07       │08       │07       │08                                   │
  │                  ││──────────┴─────────┴─────────┴─────────                            │
  │                  ││──────────┬─────────┬─────────┬─────────                            │
  │alu_imm           ││ 0000402A │0000402B │FFFFFFAA │0000FFAA                             │
  │                  ││──────────┴─────────┴─────────┴─────────                            │
  │mem_write_enable  ││                                                                    │
  │                  ││────────────────────────────────────────                            │
  │                  ││────────────────────────────────────────                            │
  │rdest             ││ 08                                                                 │
  │                  ││────────────────────────────────────────                            │
  │reg_write_enable  ││────────────────────────────────────────                            │
  │                  ││                                                                    │
  │                  ││────────────────────────────────────────                            │
  │rs                ││ 09                                                                 │
  │                  ││────────────────────────────────────────                            │
  │                  ││────────────────────┬───────────────────                            │
  │rt                ││ 0A                 │08                                             │
  │                  ││────────────────────┴───────────────────                            │
  │sel_imm_for_alu   ││                    ┌───────────────────                            │
  │                  ││────────────────────┘                                               │
  │sel_mem_for_reg_da││                                                                    │
  │                  ││────────────────────────────────────────                            │
  │sel_shift_for_alu ││                                                                    │
  │                  ││────────────────────────────────────────                            │
  │                  ││────────────────────┬───────────────────                            │
  │shamt             ││ 00                 │1E                                             │
  │                  ││────────────────────┴───────────────────                            │
  │stall_pc          ││                                                                    │
  │                  ││────────────────────────────────────────                            │
  └──────────────────┘└────────────────────────────────────────────────────────────────────┘
|}]

let%expect_test "Control signals and alu_imm correct for memory ops" =
  let lw = "32'h8D28FFAA" in
  let sw = "32'hAD28FFAA" in

  let waves = testbench [ lw; sw ] in
  Waveform.print ~wave_width:4 ~display_width:90 ~display_height:35 waves;
  [%expect
    {|
  ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
  │                  ││──────────┬─────────                                                │
  │instruction       ││ 8D28FFAA │AD28FFAA                                                 │
  │                  ││──────────┴─────────                                                │
  │                  ││────────────────────                                                │
  │alu_control       ││ 02                                                                 │
  │                  ││────────────────────                                                │
  │                  ││────────────────────                                                │
  │alu_imm           ││ 0000FFAA                                                           │
  │                  ││────────────────────                                                │
  │mem_write_enable  ││          ┌─────────                                                │
  │                  ││──────────┘                                                         │
  │                  ││────────────────────                                                │
  │rdest             ││ 08                                                                 │
  │                  ││────────────────────                                                │
  │reg_write_enable  ││──────────┐                                                         │
  │                  ││          └─────────                                                │
  │                  ││────────────────────                                                │
  │rs                ││ 09                                                                 │
  │                  ││────────────────────                                                │
  │                  ││────────────────────                                                │
  │rt                ││ 08                                                                 │
  │                  ││────────────────────                                                │
  │sel_imm_for_alu   ││────────────────────                                                │
  │                  ││                                                                    │
  │sel_mem_for_reg_da││──────────┐                                                         │
  │                  ││          └─────────                                                │
  │sel_shift_for_alu ││                                                                    │
  │                  ││────────────────────                                                │
  │                  ││────────────────────                                                │
  │shamt             ││ 1E                                                                 │
  │                  ││────────────────────                                                │
  │stall_pc          ││                                                                    │
  │                  ││────────────────────                                                │
  └──────────────────┘└────────────────────────────────────────────────────────────────────┘
|}]
